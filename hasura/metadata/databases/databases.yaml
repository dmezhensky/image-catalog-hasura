- name: default
  kind: postgres
  configuration:
    connection_info:
      database_url:
        from_env: HASURA_GRAPHQL_DATABASE_URL
      isolation_level: read-committed
  tables:
    - table:
        schema: public
        name: authors
      array_relationships:
        - name: collections
          using:
            foreign_key_constraint_on:
              column: author_id
              table:
                schema: public
                name: collection_authors
        - name: images
          using:
            foreign_key_constraint_on:
              column: author_id
              table:
                schema: public
                name: images
      select_permissions:
        - role: public
          permission:
            columns:
              - email
              - id
            filter: {}

    - table:
        schema: public
        name: collections
      array_relationships:
        - name: authors
          using:
            foreign_key_constraint_on:
              column: collection_id
              table:
                schema: public
                name: collection_authors
        - name: images
          using:
            foreign_key_constraint_on:
              column: collection_id
              table:
                schema: public
                name: images
      select_permissions:
        - role: public
          permission:
            columns:
              - id
              - name
              - created_at
            filter: {}

    - table:
        schema: public
        name: images
      object_relationships:
        - name: author
          using:
            foreign_key_constraint_on: author_id
        - name: collection
          using:
            foreign_key_constraint_on: collection_id
      array_relationships:
        - name: tags
          using:
            foreign_key_constraint_on:
              column: image_id
              table:
                schema: public
                name: image_tags
      select_permissions:
        - role: public
          permission:
            columns:
              - id
              - url
              - status
              - created_at
              - collection_id
              - author_id
            filter:
              status:
                _eq: published
        - role: author
          permission:
            columns:
              - author_id
              - collection_id
              - created_at
              - id
              - status
              - updated_at
              - url
            filter: {}

    - table:
        schema: public
        name: tags
      array_relationships:
        - name: images
          using:
            foreign_key_constraint_on:
              column: tag_id
              table:
                schema: public
                name: image_tags
      select_permissions:
        - role: public
          permission:
            columns:
              - id
              - name
            filter: {}

    - table:
        schema: public
        name: image_tags
      object_relationships:
        - name: image
          using:
            foreign_key_constraint_on: image_id
        - name: tag
          using:
            foreign_key_constraint_on: tag_id

    - table:
        schema: public
        name: collection_authors
      object_relationships:
        - name: author
          using:
            foreign_key_constraint_on: author_id
        - name: collection
          using:
            foreign_key_constraint_on: collection_id
      select_permissions:
        - role: author
          permission:
            columns:
              - author_id
              - collection_id
            filter:
              author_id:
                _eq: X-Hasura-User-Id
  functions:
    - function:
        schema: public
        name: search_images_by_tags
      configuration:
        session_argument: hasura_session

    - function:
        schema: public
        name: get_recommended_images
        configuration:
          session_argument: hasura_session
